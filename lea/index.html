<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Karte Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet Basis-Kartenbibliothek CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Leaflet.draw CSS für Zeichenwerkzeuge -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      margin: 0;
      gap: 10px;
    }

    #map-container {
      width: 700px;      
      height: 500px;      
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Legend initial transparent */
    .info.legend {
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    /* Full opacity when hovered */
    .info.legend:hover {
      opacity: 1;
    }

    /* Baumsymbole in der Legende */
    .tree-symbol {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #333;
      position: relative;
      margin-right: 6px;
    }

    .tree-symbol::after {
      content: "";
      width: 5px;
      height: 5px;
      background: black;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Hellgrün → Anlagenbäume */
    .tree-symbol--anlage {
      background: #c7f3a1;
    }

    /* Dunkelgrün → Straßenbäume */
    .tree-symbol--strasse {
      background: #81b05f;
    }
  </style>
</head>

<body>

  <div id="map-container">
    <div id="map"></div>
  </div>

  <form action="Zielseite.html" method="get">
    <button id="weiter" type="button">Weiter</button>
  </form>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.draw JavaScript -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Screenshots einbinden -->
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

  <!-- Geometrie-Utilities (Flächenberechnung) -->
  <script src="https://unpkg.com/leaflet-geometryutil"></script>

  <script>
  
  
    // =======================================
    // 1. Grundkarte initialisieren
    // =======================================
    const map = L.map('map', { preferCanvas: true }).setView([52.512859, 13.415845], 11);



    // 1.1 Basiskarte 
    const basemapFarbe = L.tileLayer(
      'https://sgx.geodatenzentrum.de/wmts_basemapde/tile/1.0.0/de_basemapde_web_raster_grau/default/GLOBAL_WEBMERCATOR/{z}/{y}/{x}.png',
      {
        maxZoom: 20,
        crossOrigin: 'anonymous', // wichtig für Screenshot
        attribution: '© basemap.de'
      }
    ).addTo(map);






    // =======================================
    // 2. Feature-Gruppe für Zeichnungen
    // =======================================
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);






    // =======================================
    // 3. Zeichenwerkzeuge
    // =======================================
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        marker: false,
        circle: false,
        circlemarker: false
      }
    });

    map.addControl(drawControl);






    // =======================================
    // 4. Flächenberechnung
    // =======================================
    function formatArea(m2) {
      if (!isFinite(m2) || m2 <= 0) return '–';
      if (m2 >= 1e6) return (m2 / 1e6).toFixed(2) + ' km²';
      if (m2 >= 1e4) return (m2 / 1e4).toFixed(2) + ' ha';
      return m2.toFixed(2) + ' m²';
    }

    function polygonAreaMeters(latlngs) {
      return L.GeometryUtil.geodesicArea(latlngs);
    }





    // =======================================
    // 5. Reaktionen auf Zeichnen / Bearbeiten
    // =======================================


    // 5.1 Neues Objekt erstellt
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);

      if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
        const ring = layer.getLatLngs()[0];   // Außenring
        const areaM = polygonAreaMeters(ring); // m²
        layer.bindPopup('Fläche: <b>' + formatArea(areaM) + '</b>').openPopup();
      }
    });



    // 5.2 Bestehende Objekte bearbeitet
    map.on(L.Draw.Event.EDITED, function (e) {
      e.layers.eachLayer(layer => {
        if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
          const ring = layer.getLatLngs()[0];
          const areaM = polygonAreaMeters(ring);
          layer.bindPopup('Fläche: <b>' + formatArea(areaM) + '</b>');
        }
      });
    });






    // =======================================
    // 6. Weiter-Button: GeoJSON + Screenshot
    // =======================================
    document.getElementById("weiter").addEventListener("click", function (e) {
      e.preventDefault();



      // 6.1 GeoJSON der Zeichnungen sichern
      const geo = drawnItems.toGeoJSON();
      localStorage.setItem("polygonData", JSON.stringify(geo));



      // 6.2 Karte inkl. Overlays als PNG rendern und sichern
      leafletImage(map, function (err, canvas) {
        if (err) {
          console.error(err);
          window.location.href = "Zielseite.html";
          return;
        }

        const imgData = canvas.toDataURL("image/png");
        localStorage.setItem("mapSnapshot", imgData);



        // 6.3 Weiter zur Zielseite
        window.location.href = "Zielseite.html";
      });
    });






    // =======================================
    // 7. WMS-Layer
    // =======================================



    // 7.1 Aufgrabeverbote
    const aufgrabeverbote = L.tileLayer.wms(
      'https://gdi.berlin.de/services/wms/aufgrabeverbote',
      {
        layers: 'aufgrabeverbote',
        format: 'image/png',
        transparent: true,
        maxZoom: 20
        // attribution: 'Daten: Land Berlin – Aufgrabeverbote'
      }
    );



    // 7.2 Baumbestand Anlagenbäume
    const anlagenbaeume = L.tileLayer.wms(
      'https://gdi.berlin.de/services/wms/baumbestand',
      {
        layers: 'anlagenbaeume',
        format: 'image/png',
        transparent: true,
        maxZoom: 20
      }
    );



    // 7.3 Baumbestand Straßenbäume
    const strassenbaeume = L.tileLayer.wms(
      'https://gdi.berlin.de/services/wms/baumbestand',
      {
        layers: 'strassenbaeume',
        format: 'image/png',
        transparent: true,
        maxZoom: 20
      }
    );



    // 7.4 Orthofoto 2025
    const dop_2025 = L.tileLayer.wms(
      'https://gdi.berlin.de/services/wms/dop_2025_fruehjahr',
      {
        layers: 'dop_2025',
        format: 'image/png',
        transparent: false, // Orthofoto ist ein voll deckendes Raster
        maxZoom: 22,
        version: '1.3.0'
      }
    );



    // 7.5 Sammellayer Bäume
    const alleBaeume = L.layerGroup([
      anlagenbaeume,
      strassenbaeume
    ]);






    // =======================================
    // 8. Layer-Kontrolle
    // =======================================
    L.control.layers(
      {}, 
      {
        'Aufgrabeverbote': aufgrabeverbote,
        'Baumbestand': alleBaeume,
        'Luftbild': dop_2025
      },
      { collapsed: false }
    ).addTo(map);






    // =======================================
    // 9. Legenden
    // =======================================



    // 9.1 Legende Aufgrabeverbote
    const legend = L.control({ position: "topright" });

    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "info legend");
      div.style.background = "white";
      div.style.padding = "10px";
      div.style.borderRadius = "8px";
      div.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";

      div.innerHTML = `
        <strong>Aufgrabeverbote</strong><br>
        <i style="background:red; width:12px; height:12px; display:inline-block; margin-right:5px;"></i> Fahrbahn<br>
        <i style="background:#ADE34A; width:12px; height:12px; display:inline-block; margin-right:5px;"></i> Gehweg<br>
        <i style="background:#3F5DDD; width:12px; height:12px; display:inline-block; margin-right:5px;"></i> Radweg<br>
      `;
      return div;
    };



    // 9.2 Legende Baumbestand
    const legendTrees = L.control({ position: "topright" });

    legendTrees.onAdd = function () {
      const div = L.DomUtil.create("div", "info legend");
      div.style.background = "white";
      div.style.padding = "10px";
      div.style.borderRadius = "8px";
      div.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";

      div.innerHTML = `
        <strong>Baumbestand</strong><br>
        <span class="tree-symbol tree-symbol--anlage"></span> Anlagenbaum<br>
        <span class="tree-symbol tree-symbol--strasse"></span> Straßenbaum<br>
      `;
      return div;
    };





    // =======================================
    // 10. Dynamische Legende
    // =======================================
    map.on("overlayadd", function (e) {
      if (e.name === "Aufgrabeverbote") {
        legend.addTo(map);
      }
      if (e.name === "Baumbestand") {
        legendTrees.addTo(map);
      }
    });

    map.on("overlayremove", function (e) {
      if (e.name === "Aufgrabeverbote") {
        map.removeControl(legend);
      }
      if (e.name === "Baumbestand") {
        map.removeControl(legendTrees);
      }
    });
  </script>

</body>
</html>
